apiVersion: batch/v1
kind: Job
metadata:
  name: homepage-restart
  namespace: default
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "2"
spec:
  ttlSecondsAfterFinished: 100
  template:
    spec:
      serviceAccountName: homepage
      restartPolicy: OnFailure
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              # Get current ConfigMap resourceVersion
              CM_VERSION=$(kubectl get configmap homepage -n default -o jsonpath='{.metadata.resourceVersion}')

              # Get the resourceVersion stored in deployment annotation (if exists)
              DEPLOYMENT_CM_VERSION=$(kubectl get deployment homepage -n default -o jsonpath='{.metadata.annotations.configmap-version}' || echo "")

              echo "ConfigMap version: $CM_VERSION"
              echo "Deployment tracked version: $DEPLOYMENT_CM_VERSION"

              # Only restart if ConfigMap version changed
              if [ "$CM_VERSION" != "$DEPLOYMENT_CM_VERSION" ]; then
                echo "ConfigMap changed! Restarting deployment..."
                kubectl rollout restart deployment/homepage -n default
                echo "Waiting for rollout to complete..."
                kubectl rollout status deployment/homepage -n default --timeout=300s
                
                # Update deployment annotation with new ConfigMap version
                kubectl annotate deployment/homepage -n default configmap-version="$CM_VERSION" --overwrite
                echo "Restart complete and version tracked!"
              else
                echo "ConfigMap unchanged, skipping restart."
              fi
